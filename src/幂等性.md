# 幂等性

#### 概述

  幂等性原本是数学上的概念，即使公式：f(x)=f(f(x)) 能够成立的数学性质。用在编程领域，则意为对同一个系统，使用同样的条件，一次请求和重复的多次请求对系统资源的影响是一致的。幂等性是分布式系统设计中十分重要的概念，具有这一性质的接口在设计时总是秉持这样的一种理念：调用接口发生异常并且重复尝试时，总是会造成系统所无法承受的损失，所以必须阻止这种现象的发生。幂等有两个维度：一是空间维度上的幂等，即幂等对象的范围，是个人还是机构，是某一次交易还是某种类型的交易...二是时间维度上的幂等，即幂等的保证时间，是几秒、几分钟还是永久性的，不同的需求，会有不一样的解决方案，难度和成本也不一样

#### 适用领域

  试想这样的一种场景：在电商平台上支付后，因为网络原因导致系统提示你支付失败，于是你又重新付款了一次，等完成后检查网银发现被系统扣了两次款，这是一种什么样的体验？造成上述问题的原因可能有很多，比如第一次付款时实际支付成功，但是信息返回时网络中断导致系统误判；又比如第一次付款的确失败了，但第二次付款时发生意外，导致支付请求被重复发送等等。在一次支付的过程中，每个环节都有可能会发生问题，我们要如何规避这类问题引发的分险？幂等性是解决这类问题的方案之一，所以在电商，银行，互联网金融等对数据准确性要求很高的领域中，这一特性具有十分重要的地位

#### 幂等的常用思路

1. MVCC
    
    多版本并发控制，乐观锁的一种实现，在数据更新时需要去比较持有数据的版本号，版本号不一致的操作无法成功。例如博客点赞次数自动+1的接口
    
    ```java
    public boolean addCount(Long id, Long version);
    ```
    
    ```sql
    update blogTable set count = count + 1,version = version + 1 where id = 321 and version = 123
    ```
  
2. 去重表

	利用数据库表单的特性来实现幂等，常用的一个思路是在表上构建唯一性索引，保证某一类数据一旦执行完毕，后续同样的请求再也无法成功写入。例子还是上述的博客点赞问题，要想防止一个人重复点赞，可以设计一张表，将博客id与用户id绑定建立唯一索引，每当用户点赞时就往表中写入一条数据，这样重复点赞的数据就无法写入

3. TOKEN机制

	从上面的一步步分析可以看出：其实架构的设计就是一系列相关的抽象。先是抽象出 HTTP 服务，用来通信和解析协议。再因为业务的复杂，为了不和 HTTP 服务耦合又抽象了一层 Servlet。由 Servlet 加载和管理 Servlet ，来控制请求转发到指定的 Servlet 实现类。然后我们安心的开发业务即可。因为抽象所以灵活易扩展，比如现在是 HTTP1.1 服务，可以换成 HTTP 2。现在用 Tomcat 来作为 Servlet 容器，也可以换成 Jetty。现在用原生的实现 Servlet 来做业务，也可以换成 SpringMVC。随意变更，因为都抽象出来了，就很好替换，只要遵循约定的接口实现即可